{%- import 'common.jinja2' as common -%}
---
test-suites:
  cli_commands:
    test_cli_commands.py::test_sit_cli_commands:
      dimensions:
        - regions: ["us-west-2"]
          instances: {{ common.INSTANCES_DEFAULT_X86 }}
          oss: ["centos7"]
          schedulers: ["sge"]
  cloudwatch_logging:
    test_cloudwatch_logging.py::test_cloudwatch_logging:
      dimensions:
        # 1) run the test for all of the schedulers with alinux2
        - regions: ["us-gov-east-1"]
          instances: {{ common.INSTANCES_DEFAULT_X86 }}
          oss: ["alinux2"]
          schedulers: ["awsbatch"]
        - regions: ["ap-east-1", "me-south-1", "af-south-1", "eu-south-1"]
          instances: {{ common.INSTANCES_DEFAULT_X86 }}
          oss: ["alinux2"]
          schedulers: ["slurm"]
  configure:
    test_pcluster_configure.py::test_pcluster_configure:
      dimensions:
        - regions: ["us-east-1"]
          instances: {{ common.INSTANCES_DEFAULT_ARM }}
          oss: ["alinux2"]
          schedulers: ["slurm"]
        # Do not run on ARM + Batch
        # pcluster configure always picks optimal and Batch does not support ARM for optimal for now
        - regions: ["us-gov-west-1"]
          instances: {{ common.INSTANCES_DEFAULT_X86 }}
          oss: ["alinux2"]
          schedulers: ["awsbatch"]
    test_pcluster_configure.py::test_pcluster_configure_avoid_bad_subnets:
      dimensions:
        - regions: ["us-east-1"]  # region must be us-east-1 due to hardcoded logic for AZ selection
          instances: {{ common.INSTANCES_DEFAULT_X86 }}
          oss: ["alinux2"]
          schedulers: ["slurm"]
  dcv:
    test_dcv.py::test_dcv_configuration:
      dimensions:
        # DCV in gov-cloud regions and non GPU enabled instance
        - regions: ["us-gov-west-1"]
          instances: {{ common.INSTANCES_DEFAULT_X86 }}
          oss: ["ubuntu1804"]
          schedulers: ["slurm"]
  efa:
    test_efa.py::test_hit_efa:
      dimensions:
        - regions: ["us-east-1"]
          instances: ["c5n.18xlarge"]
          oss: ["alinux2"]
          schedulers: ["slurm"]
    test_efa.py::test_sit_efa:
      dimensions:
        - regions: ["us-east-1"]
          instances: ["c5n.18xlarge"]
          oss: {{ common.OSS_COMMERCIAL_X86 }}
          # Torque is not supported by OpenMPI distributed with EFA
          # Slurm test is to verify EFA works correctly when using the SIT model in the config file
          schedulers: ["sge", "slurm"]
  intel_hpc:
    test_intel_hpc.py::test_intel_hpc:
      dimensions:
        - regions: ["us-east-1"]
          instances: ["c5n.18xlarge"]
          oss: ["centos7", "centos8"]
          schedulers: ["slurm"]
  networking:
    test_cluster_networking.py::test_cluster_in_private_subnet:
      dimensions:
        - regions: ["us-west-2"]
          instances: {{ common.INSTANCES_DEFAULT_X86 }}
          oss: ["alinux2"]
          schedulers: ["slurm"]
    test_networking.py::test_public_network_topology:
      dimensions:
        - regions: ["us-gov-east-1"]
    test_networking.py::test_public_private_network_topology:
      dimensions:
        - regions: ["us-gov-east-1"]
  scaling:
    test_scaling.py::test_multiple_jobs_submission:
      dimensions:
        - regions: ["us-west-2", "us-east-1"]
          instances: {{ common.INSTANCES_DEFAULT_X86 }}
          oss: {{ common.OSS_COMMERCIAL_X86 }}
          schedulers: ["slurm", "sge"]
        - regions: {{ common.REGIONS_GOVCLOUD }}
          instances: {{ common.INSTANCES_DEFAULT_X86 }}
          oss: {{ common.OSS_GOVCLOUD_X86 }}
          schedulers: ["slurm", "sge"]
        - regions: ["us-west-2"]
          instances: {{ common.INSTANCES_DEFAULT_ARM }}
          oss: {{ common.OSS_COMMERCIAL_ARM }}
          schedulers: {{ common.SCHEDULERS_TRAD }}
    test_mpi.py::test_mpi:
      dimensions:
        - regions: ["us-east-1"]
          instances: {{ common.INSTANCES_DEFAULT_ARM }}
          oss: {{ common.OSS_COMMERCIAL_ARM }}
          schedulers: ["slurm", "sge"]
  schedulers:
    test_awsbatch.py::test_awsbatch:
      dimensions:
        - regions: ["us-gov-west-1"]
          instances: {{ common.INSTANCES_DEFAULT_X86 }}
          oss: ["alinux2"]
          schedulers: ["awsbatch"]
  spot:
    test_spot.py::test_spot_default:
      dimensions:
        - regions: ["us-west-2"]
          instances: {{ common.INSTANCES_DEFAULT_X86 }}
          oss: ["centos7"]
          schedulers: ["sge", "slurm"]
  storage:
    test_fsx_lustre.py::test_fsx_lustre_backup: # yes
      dimensions:
        - regions: ["us-west-2"]
          instances: {{ common.INSTANCES_DEFAULT_X86 }}
          oss: {{ common.OSS_ONE_PER_DISTRO }}
          schedulers: ["sge"]
        - regions: ["us-west-2"]
          instances: {{ common.INSTANCES_DEFAULT_ARM }}
          # FSx is only supported on ARM instances for Ubuntu 18.04, Amazon Linux 2 and CentOS 8
          oss: ["alinux2", "ubuntu1804", "centos8"]
          schedulers: ["sge"]
        - regions: ["cn-north-1"]
          instances: {{ common.INSTANCES_DEFAULT_X86 }}
          oss: ["alinux"]
          schedulers: ["slurm"]
    test_raid.py::test_raid_performance_mode:
      dimensions:
        - regions: ["us-gov-east-1"]
          instances: {{ common.INSTANCES_DEFAULT_X86 }}
          oss: {{ common.OSS_GOVCLOUD_X86 }}
          schedulers: ["sge"]
    test_ebs.py::test_ebs_single_empty:
      dimensions:
        {%- for region, oss in [("us-west-2", common.OSS_COMMERCIAL_X86), ("us-gov-west-1", common.OSS_GOVCLOUD_X86)] %}
        - regions: ["{{ region }}"]
          instances: {{ common.INSTANCES_DEFAULT_X86 }}
          oss: {{ oss }}
          schedulers: ["sge"]
        {%- endfor %}
